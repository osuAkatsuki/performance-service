# Full PP Recalculation - All modes, all variants
#
# This recalculates PP for ALL scores across ALL game modes and variants.
# WARNING: This is a long-running job that may take hours.
#
# Apply:   kubectl apply -f full-recalc.yaml
# Monitor: kubectl logs -f job/performance-service-deploy-full-recalc
# Delete:  kubectl delete job performance-service-deploy-full-recalc

apiVersion: batch/v1
kind: Job
metadata:
  name: performance-service-deploy-full-recalc
spec:
  ttlSecondsAfterFinished: 86400
  template:
    metadata:
      labels:
        sidecar.istio.io/inject: "false"
    spec:
      containers:
      - name: performance-service
        image: osuakatsuki/performance-service:latest
        imagePullPolicy: Always
        env:
          - name: KUBERNETES
            value: "true"
          - name: PULL_SECRETS_FROM_VAULT
            value: "1"
          - name: VAULT_ADDR
            valueFrom:
              secretKeyRef:
                name: vault
                key: address
          - name: VAULT_TOKEN
            valueFrom:
              secretKeyRef:
                name: vault
                key: token
          - name: APP_ENV
            value: production
          - name: APP_COMPONENT
            value: deploy
          - name: DEPLOY_MODES
            value: "0,1,2,3"
          - name: DEPLOY_RELAX_BITS
            value: "0,1,2"
          - name: DEPLOY_TOTAL_PP_ONLY
            value: "0"
          - name: DEPLOY_TOTAL_PP
            value: "1"
      restartPolicy: Never
      imagePullSecrets:
        - name: osuakatsuki-registry-secret
