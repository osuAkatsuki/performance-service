# Re-aggregate User Totals Only
#
# Skips Phase 1 (score PP recalculation) and only runs Phase 2:
# - Recalculates which score is "best" per beatmap
# - Aggregates user total PP from existing score PP values
# - Updates Redis leaderboards
#
# Use this when:
# - A previous recalc crashed during Phase 2
# - You need to rebuild leaderboards without changing score PP
#
# Apply:   kubectl apply -f reaggregate-only.yaml
# Monitor: kubectl logs -f job/performance-service-deploy-reaggregate-only
# Delete:  kubectl delete job performance-service-deploy-reaggregate-only

apiVersion: batch/v1
kind: Job
metadata:
  name: performance-service-deploy-reaggregate-only
spec:
  ttlSecondsAfterFinished: 86400
  template:
    metadata:
      labels:
        sidecar.istio.io/inject: "false"
    spec:
      containers:
      - name: performance-service
        image: osuakatsuki/performance-service:latest
        imagePullPolicy: Always
        env:
          - name: KUBERNETES
            value: "true"
          - name: PULL_SECRETS_FROM_VAULT
            value: "1"
          - name: VAULT_ADDR
            valueFrom:
              secretKeyRef:
                name: vault
                key: address
          - name: VAULT_TOKEN
            valueFrom:
              secretKeyRef:
                name: vault
                key: token
          - name: APP_ENV
            value: production
          - name: APP_COMPONENT
            value: deploy
          - name: DEPLOY_MODES
            value: "0,1,2,3"
          - name: DEPLOY_RELAX_BITS
            value: "0,1,2"
          - name: DEPLOY_TOTAL_PP_ONLY
            value: "1"
          - name: DEPLOY_TOTAL_PP
            value: "1"
      restartPolicy: Never
      imagePullSecrets:
        - name: osuakatsuki-registry-secret
